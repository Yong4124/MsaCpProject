<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</title>
    <style>
        body { margin:0; font-family: Arial, sans-serif; }
        .topbar {
            height:64px; display:flex; align-items:center; justify-content:space-between;
            padding:0 24px; border-bottom:1px solid #eee;
        }
        .title { font-size:24px; font-weight:800; }
        .btn {
            border:0; padding:10px 18px; border-radius:999px; cursor:pointer;
            background:#333; color:#fff; font-weight:700;
        }
        .wrap { padding:24px; }
        .empty {
            margin-top:80px; text-align:center; color:#222; font-size:18px;
        }

        /* âœ… ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .list { max-width:820px; margin:24px auto 0; display:flex; flex-direction:column; gap:12px; }
        .card {
            border:1px solid #eee; border-radius:14px; padding:14px 16px;
            display:flex; gap:12px; align-items:flex-start; cursor:pointer;
            transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
        }
        .card:hover { transform: translateY(-1px); }
        .card.selected {
            border-color:#111;
            box-shadow: 0 0 0 1px #111 inset;
        }

        .radio {
            margin-top:4px;
        }

        .logo {
            width:46px; height:46px; border-radius:12px; overflow:hidden;
            background:#f3f3f3; flex:0 0 auto;
            display:flex; align-items:center; justify-content:center;
            font-weight:800; color:#777;
        }
        .logo img { width:100%; height:100%; object-fit:cover; display:block; }

        .meta { display:flex; flex-direction:column; gap:6px; flex:1; min-width:0; }
        .company { font-size:13px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .jobtitle { font-size:16px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        .bottom {
            display:flex; align-items:center; justify-content:space-between;
            gap:10px; margin-top:2px;
        }
        .badge {
            font-size:12px; font-weight:800;
            padding:6px 10px; border-radius:999px;
            border:1px solid #ddd; background:#fff; color:#333;
            flex:0 0 auto;
        }
        /* ë°°ì§€ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ */
        .badge.temp { border-color:#e2e2e2; color:#555; background-color: #f9f9f9; } /* ì‘ì„±ì¤‘: íšŒìƒ‰ */
        .badge.submitted { border-color:#cfd8ff; color:#1d3cff; background-color: #f0f4ff; } /* ì œì¶œì™„ë£Œ: íŒŒë€ìƒ‰ */
        .badge.cancel { border-color:#ffd0d0; color:#d40000; background-color: #fff0f0; } /* ì§€ì›ì·¨ì†Œ: ë¹¨ê°„ìƒ‰ */

        .sub {
            font-size:12px; color:#777;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }

        .actions {
            max-width:820px; margin:16px auto 0; display:flex; gap:10px; justify-content:flex-end;
        }
        .btn2 {
            border:1px solid #ddd; padding:10px 14px; border-radius:10px; cursor:pointer;
            background:#fff; font-weight:700;
        }
        .btn2.primary { background:#111; color:#fff; border-color:#111; }
    </style>
</head>
<body>
<div class="topbar">
    <div class="title">ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
    <button class="btn" id="closeBtn">ë‹«ê¸°</button>
</div>

<div class="wrap">
    <div id="empty" class="empty" style="display:none;">
        ì €ì¥ëœ ì´ë ¥ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div id="list" class="list" style="display:none;"></div>

    <div class="actions" id="actions" style="display:none;">
        <button class="btn2 primary" id="loadSelectedBtn">ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
</div>

<script>
    const ENDPOINT_APPLY_MY = (page=0,size=10) => `/api/apply/my?page=${page}&size=${size}`;
    const ENDPOINT_RESUME_LATEST = `/api/resume/me`;

    const $ = (s) => document.querySelector(s);
    const listEl = $("#list");
    const emptyEl = $("#empty");
    const actionsEl = $("#actions");

    $("#closeBtn").addEventListener("click", () => window.close());

    async function fetchJson(url) {
        const res = await fetch(url, { method:"GET", credentials:"include", cache:"no-store" });
        if (res.status === 401) {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.");
            window.close();
            throw new Error("401");
        }
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (!ct.includes("application/json")) throw new Error("Not JSON");
        return await res.json();
    }

    function sendPicked(m110) {
        if (!window.opener) return;
        window.opener.postMessage({ type:"RESUME_PICKED", m110 }, window.location.origin);
        window.close();
    }

    function getPicked() {
        return document.querySelector('input[name="resumePick"]:checked')?.value || "";
    }

    // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] ìƒíƒœ í…ìŠ¤íŠ¸ ë° ìŠ¤íƒ€ì¼ ê²°ì • í•¨ìˆ˜
    function statusClassAndText(it) {
        const statusText = it?.statusText ?? "";
        const reviewStatus = (it?.reviewStatus ?? "").toUpperCase();
        const cancelStatus = (it?.cancelStatus ?? "");

        // 1. í…ìŠ¤íŠ¸ì— íŒíŠ¸ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
        if (statusText.includes("ì·¨ì†Œ")) return { cls:"cancel", text:"ì§€ì›ì·¨ì†Œ" };
        if (statusText.includes("ì œì¶œ")) return { cls:"submitted", text:"ì œì¶œì™„ë£Œ" };
        if (statusText.includes("ì‘ì„±")) return { cls:"temp", text:"ì„ì‹œì €ì¥" };

        // 2. ì·¨ì†Œ ì—¬ë¶€ í™•ì¸ (í™•ì‹¤íˆ 'Y'ì¼ ë•Œë§Œ)
        if (cancelStatus === "Y") return { cls:"cancel", text:"ì§€ì›ì·¨ì†Œ" };

        // 3. ì œì¶œ ì—¬ë¶€ í™•ì¸
        if (reviewStatus === "SUBMITTED") return { cls:"submitted", text:"ì œì¶œì™„ë£Œ" };

        // 4. ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‘ì„±ì¤‘(ì„ì‹œì €ì¥)
        return { cls:"temp", text:"ì„ì‹œì €ì¥ " };
    }

    function renderCards(items) {
        listEl.innerHTML = "";

        items.forEach((it, idx) => {
            const resumeId = it?.resumeId ?? it?.seqNoM110 ?? it?.SEQ_NO_M110;
            const jobTitle = it?.title ?? it?.jobTitle ?? "";
            const companyName = it?.companyName ?? "";
            const logoPath = it?.logoPath ?? "";

            const { cls, text } = statusClassAndText(it);

            const card = document.createElement("label");
            card.className = "card";
            card.innerHTML = `
              <input class="radio" type="radio" name="resumePick" value="${resumeId ?? ""}" ${idx===0 ? "checked":""} />
              <div class="logo">
                ${logoPath ? `<img alt="logo" src="${logoPath}">` : `<span>LOGO</span>`}
              </div>
              <div class="meta">
                <div class="company">${companyName || "-"}</div>
                <div class="jobtitle">${jobTitle || "-"}</div>
                <div class="bottom">
                  <span class="badge ${cls}">${text}</span>
                  <span class="sub">ì´ë ¥ì„œ #${resumeId ?? "-"}</span>
                </div>
              </div>
            `;

            // ì„ íƒ í‘œì‹œ ë¡œì§
            const radio = card.querySelector('input[type="radio"]');
            const syncSelected = () => {
                document.querySelectorAll(".card").forEach(el => el.classList.remove("selected"));
                card.classList.add("selected");
            };
            card.addEventListener("click", () => {
                radio.checked = true;
                syncSelected();
            });

            listEl.appendChild(card);

            if (idx === 0) {
                card.classList.add("selected");
            }
        });

        // ë¼ë””ì˜¤ ë³€ê²½ ê°ì§€
        document.querySelectorAll('input[name="resumePick"]').forEach(r => {
            r.addEventListener("change", () => {
                document.querySelectorAll(".card").forEach(el => el.classList.remove("selected"));
                r.closest(".card")?.classList.add("selected");
            });
        });
    }

    async function renderList() {
        let raw;
        try {
            raw = await fetchJson(ENDPOINT_APPLY_MY(0, 10));
        } catch (e) {
            emptyEl.style.display = "block";
            return;
        }

        const data = raw?.data ?? raw;
        const items = data?.items ?? [];

        if (!items.length) {
            emptyEl.style.display = "block";
            listEl.style.display = "none";
            actionsEl.style.display = "none";
            return;
        }

        emptyEl.style.display = "none";
        listEl.style.display = "flex";
        actionsEl.style.display = "flex";

        renderCards(items);
    }

    $("#loadSelectedBtn")?.addEventListener("click", async () => {
        const picked = getPicked();
        if (!picked) return alert("í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        sendPicked(picked);
    });

    renderList();
</script>
</body>
</html>