<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('USFK Jobs - 지원자 관리')}"></head>
<body>
<nav th:replace="~{fragments/layout :: header}"></nav>

<main class="py-5">
    <div class="container">
        <!-- 메시지 -->
        <div class="alert alert-success alert-dismissible fade show" th:if="${successMessage}">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${successMessage}">성공</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- 뒤로가기 -->
        <div class="mb-4">
            <a th:href="@{/company/jobs}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>채용공고 목록
            </a>
        </div>
        
        <!-- 공고 정보 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h4 th:text="${job.title}" class="mb-2">공고 제목</h4>
                <p class="text-muted mb-0">
                    모집기간: 
                    <span th:text="${#temporals.format(job.startDate, 'yyyy-MM-dd')}">시작일</span> ~
                    <span th:text="${#temporals.format(job.endDate, 'yyyy-MM-dd')}">마감일</span>
                </p>
            </div>
        </div>
        
        <!-- 필터 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a th:href="@{/company/jobs/{id}/applicants(id=${job.id})}" 
                       th:classappend="${selectedStatus == null} ? 'active'" 
                       class="btn btn-outline-primary">
                        전체 <span class="badge bg-primary" th:text="${#lists.size(job.applications)}">0</span>
                    </a>
                    <a th:href="@{/company/jobs/{id}/applicants(id=${job.id}, status=0)}" 
                       th:classappend="${selectedStatus == 0} ? 'active'" 
                       class="btn btn-outline-secondary">미심사</a>
                    <a th:href="@{/company/jobs/{id}/applicants(id=${job.id}, status=1)}" 
                       th:classappend="${selectedStatus == 1} ? 'active'" 
                       class="btn btn-outline-info">1차 합격</a>
                    <a th:href="@{/company/jobs/{id}/applicants(id=${job.id}, status=2)}" 
                       th:classappend="${selectedStatus == 2} ? 'active'" 
                       class="btn btn-outline-success">최종 합격</a>
                    <a th:href="@{/company/jobs/{id}/applicants(id=${job.id}, status=3)}" 
                       th:classappend="${selectedStatus == 3} ? 'active'" 
                       class="btn btn-outline-danger">불합격</a>
                </div>
            </div>
        </div>
        
        <!-- 지원자 목록 -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-people me-2 text-success"></i>지원자 목록</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" th:if="${not #lists.isEmpty(applications)}">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>지원자</th>
                                <th>이메일</th>
                                <th>학력</th>
                                <th>심사상태</th>
                                <th>상태변경</th>
                                <th>이력서</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="app : ${applications}">
                                <td>
                                    <strong th:text="${app.personalMember.firstName + ' ' + app.personalMember.lastName}">홍길동</strong>
                                    <br>
                                    <small class="text-muted" th:if="${app.personalMember.serviceBranch}">
                                        <i class="bi bi-shield me-1"></i>
                                        <span th:switch="${app.personalMember.serviceBranch}">
                                            <span th:case="'1'">KATUSA</span>
                                            <span th:case="'2'">ROK Air Force</span>
                                            <span th:case="'3'">ROK Army</span>
                                            <span th:case="'7'">U.S Air Force</span>
                                            <span th:case="'8'">U.S Army</span>
                                            <span th:case="*" th:text="${app.personalMember.serviceBranch}">소속군</span>
                                        </span>
                                    </small>
                                </td>
                                <td th:text="${app.personalMember.email}">email@example.com</td>
                                <td>
                                    <span th:if="${app.resume.school}" th:text="${app.resume.school}">학교</span>
                                    <span th:unless="${app.resume.school}" class="text-muted">-</span>
                                    <br>
                                    <small class="text-muted" th:if="${app.resume.major}" th:text="${app.resume.major}">전공</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary" th:if="${app.reviewStatus == 0}">미심사</span>
                                    <span class="badge bg-info" th:if="${app.reviewStatus == 1}">1차 합격</span>
                                    <span class="badge bg-success" th:if="${app.reviewStatus == 2}">최종 합격</span>
                                    <span class="badge bg-danger" th:if="${app.reviewStatus == 3}">불합격</span>
                                    <span class="badge bg-warning" th:if="${app.cancelStatus == 'Y'}">지원취소</span>
                                </td>
                                <td>
                                    <form th:action="@{/company/applicants/{id}/status(id=${app.id})}" method="post" 
                                          th:if="${app.cancelStatus != 'Y'}" class="d-flex gap-1">
                                        <input type="hidden" name="jobId" th:value="${job.id}">
                                        <select name="status" class="form-select form-select-sm" style="width: auto;">
                                            <option value="0" th:selected="${app.reviewStatus == 0}">미심사</option>
                                            <option value="1" th:selected="${app.reviewStatus == 1}">1차 합격</option>
                                            <option value="2" th:selected="${app.reviewStatus == 2}">최종 합격</option>
                                            <option value="3" th:selected="${app.reviewStatus == 3}">불합격</option>
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">변경</button>
                                    </form>
                                    <span th:if="${app.cancelStatus == 'Y'}" class="text-muted">-</span>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            data-bs-toggle="modal" th:data-bs-target="'#resumeModal' + ${app.id}">
                                        <i class="bi bi-file-earmark-person"></i> 보기
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center text-muted py-5" th:if="${#lists.isEmpty(applications)}">
                    <i class="bi bi-people display-4 d-block mb-3"></i>
                    <h5>지원자가 없습니다.</h5>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 이력서 모달 -->
<div th:each="app : ${applications}">
    <div class="modal fade" th:id="'resumeModal' + ${app.id}" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-person me-2"></i>
                        <span th:text="${app.personalMember.firstName + ' ' + app.personalMember.lastName}">지원자</span> 이력서
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 기본 정보 -->
                    <h6 class="text-primary mb-3"><i class="bi bi-person me-2"></i>기본 정보</h6>
                    <table class="table table-sm">
                        <tr>
                            <th class="bg-light" style="width: 120px;">이름</th>
                            <td th:text="${app.personalMember.firstName + ' ' + app.personalMember.lastName}">이름</td>
                            <th class="bg-light" style="width: 120px;">이메일</th>
                            <td th:text="${app.resume.email ?: app.personalMember.email}">이메일</td>
                        </tr>
                        <tr>
                            <th class="bg-light">연락처</th>
                            <td th:text="${app.resume.phone ?: '-'}">연락처</td>
                            <th class="bg-light">주소</th>
                            <td th:text="${app.resume.address ?: '-'}">주소</td>
                        </tr>
                    </table>
                    
                    <!-- 학력 -->
                    <h6 class="text-primary mb-3 mt-4"><i class="bi bi-mortarboard me-2"></i>학력</h6>
                    <table class="table table-sm">
                        <tr>
                            <th class="bg-light" style="width: 120px;">학교</th>
                            <td th:text="${app.resume.school ?: '-'}">학교</td>
                            <th class="bg-light" style="width: 120px;">전공</th>
                            <td th:text="${app.resume.major ?: '-'}">전공</td>
                        </tr>
                        <tr>
                            <th class="bg-light">재학기간</th>
                            <td th:text="${(app.resume.enrollDate ?: '') + ' ~ ' + (app.resume.graduateDate ?: '')}">기간</td>
                            <th class="bg-light">학점</th>
                            <td th:text="${app.resume.gpa ?: '-'}">학점</td>
                        </tr>
                    </table>
                    
                    <!-- 군 정보 -->
                    <h6 class="text-primary mb-3 mt-4"><i class="bi bi-shield me-2"></i>군 경력</h6>
                    <table class="table table-sm">
                        <tr>
                            <th class="bg-light" style="width: 120px;">복무형태</th>
                            <td th:text="${app.personalMember.serviceCategory ?: '-'}">복무형태</td>
                            <th class="bg-light" style="width: 120px;">소속군</th>
                            <td th:text="${app.personalMember.serviceBranch ?: '-'}">소속군</td>
                        </tr>
                        <tr>
                            <th class="bg-light">계급</th>
                            <td th:text="${app.personalMember.lastRank ?: '-'}">계급</td>
                            <th class="bg-light">복무기간</th>
                            <td th:text="${app.personalMember.serviceYear ?: '-'}">복무기간</td>
                        </tr>
                    </table>
                    
                    <!-- 전문분야 -->
                    <div th:if="${app.resume.skill}">
                        <h6 class="text-primary mb-3 mt-4"><i class="bi bi-tools me-2"></i>전문분야</h6>
                        <p th:text="${app.resume.skill}">전문분야</p>
                    </div>
                    
                    <!-- 자기소개 -->
                    <div th:if="${app.resume.selfIntro}">
                        <h6 class="text-primary mb-3 mt-4"><i class="bi bi-chat-quote me-2"></i>자기소개</h6>
                        <p th:utext="${#strings.replace(app.resume.selfIntro, T(System).lineSeparator(), '&lt;br&gt;')}">자기소개</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>
</body>
</html>
