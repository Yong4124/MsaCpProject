<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('USFK Jobs - ' + ${job.title})}"></head>
<body>
<nav th:replace="~{fragments/layout :: header}"></nav>

<main class="py-5">
    <div class="container">
        <div class="row">
            <!-- 메인 콘텐츠 -->
            <div class="col-lg-8">
                <!-- 뒤로가기 -->
                <div class="mb-3">
                    <a th:href="@{/job/list}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>목록으로
                    </a>
                </div>

                <!-- 공고 헤더 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <span class="badge bg-primary mb-2" th:text="${job.jobCategory}">직종</span>
                                <h2 class="mb-1" th:text="${job.title}">공고 제목</h2>
                                <h5 class="text-muted" th:text="${job.companyMember.company}">회사명</h5>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-danger fs-6" th:if="${dDay >= 0}">
                                    D-<span th:text="${dDay}">0</span>
                                </span>
                                <span class="badge bg-secondary fs-6" th:if="${dDay < 0}">마감</span>
                            </div>
                        </div>
                        <div class="row text-muted small">
                            <div class="col-auto">
                                <i class="bi bi-calendar me-1"></i>
                                <span th:text="${#temporals.format(job.startDate, 'yyyy-MM-dd')}">시작</span> ~
                                <span th:text="${#temporals.format(job.endDate, 'yyyy-MM-dd')}">마감</span>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-geo-alt me-1"></i>
                                <span th:text="${job.jobLocation ?: '미정'}">위치</span>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-briefcase me-1"></i>
                                <span th:text="${job.jobType ?: '미정'}">고용형태</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 모집 조건 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check me-2 text-primary"></i>모집 조건</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>경력</strong>
                                <p class="text-muted mb-0" th:text="${job.experience ?: '무관'}">경력</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>직급</strong>
                                <p class="text-muted mb-0" th:text="${job.roleLevel ?: '무관'}">직급</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>고용형태</strong>
                                <p class="text-muted mb-0" th:text="${job.jobForm ?: '정규직'}">고용형태</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>근무시간</strong>
                                <p class="text-muted mb-0" th:text="${job.workTime ?: '협의'}">근무시간</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>급여</strong>
                                <p class="text-muted mb-0" th:text="${job.baseSalary ?: '협의'}">급여</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>근무지역</strong>
                                <p class="text-muted mb-0" th:text="${job.jobLocation ?: '협의'}">지역</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 상세 내용 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2 text-primary"></i>상세 내용</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="fw-bold">담당업무</h6>
                        <p class="mb-4 text-muted" style="white-space: pre-line;" th:text="${job.positionSummary ?: '-'}">담당업무</p>

                        <h6 class="fw-bold">자격요건</h6>
                        <p class="mb-4 text-muted" style="white-space: pre-line;" th:text="${job.skillQualification ?: '-'}">자격요건</p>

                        <h6 class="fw-bold">복리후생</h6>
                        <p class="mb-4 text-muted" style="white-space: pre-line;" th:text="${job.benefits ?: '-'}">복리후생</p>

                        <div th:if="${job.notes}">
                            <h6 class="fw-bold">기타사항</h6>
                            <p class="text-muted" style="white-space: pre-line;" th:text="${job.notes}">기타사항</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 사이드바 -->
            <div class="col-lg-4">
                <!-- 기업 정보 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-building me-2 text-primary"></i>기업 정보</h5>
                    </div>
                    <div class="card-body">
                        <h5 th:text="${job.companyMember.company}">회사명</h5>
                        <table class="table table-sm table-borderless small">
                            <tr th:if="${job.industry}">
                                <th class="text-muted">업종</th>
                                <td th:text="${job.industry}">업종</td>
                            </tr>
                            <tr th:if="${job.companyType}">
                                <th class="text-muted">기업형태</th>
                                <td th:text="${job.companyType}">기업형태</td>
                            </tr>
                            <tr th:if="${job.employeeNum}">
                                <th class="text-muted">사원수</th>
                                <td th:text="${job.employeeNum}">사원수</td>
                            </tr>
                            <tr th:if="${job.establishedDate}">
                                <th class="text-muted">설립일</th>
                                <td th:text="${job.establishedDate}">설립일</td>
                            </tr>
                            <tr th:if="${job.capital}">
                                <th class="text-muted">자본금</th>
                                <td th:text="${job.capital}">자본금</td>
                            </tr>
                            <tr th:if="${job.revenue}">
                                <th class="text-muted">매출액</th>
                                <td th:text="${job.revenue}">매출액</td>
                            </tr>
                            <tr th:if="${job.homepage}">
                                <th class="text-muted">홈페이지</th>
                                <td><a th:href="${job.homepage}" target="_blank" th:text="${job.homepage}">홈페이지</a></td>
                            </tr>
                        </table>
                        <div th:if="${job.companyIntro}" class="mt-3">
                            <h6 class="fw-bold">회사소개</h6>
                            <p class="small text-muted" style="white-space: pre-line;" th:text="${job.companyIntro}">회사소개</p>
                        </div>
                    </div>
                </div>

                <!-- 지원 버튼 -->
                <div class="card shadow-sm sticky-top" style="top: 80px;">
                    <div class="card-body">
                        <!-- 비로그인 -->
                        <div sec:authorize="!isAuthenticated()">
                            <a th:href="@{/auth/login}" class="btn btn-primary btn-lg w-100 mb-2">
                                <i class="bi bi-box-arrow-in-right me-2"></i>로그인 후 지원
                            </a>
                            <p class="text-muted small text-center mb-0">회원가입 후 지원 가능합니다.</p>
                        </div>

                        <!-- 개인회원 -->
                        <div sec:authorize="hasRole('PERSONAL')">
                            <div th:if="${dDay >= 0}">
                                <div th:if="${hasApplied}">
                                    <button class="btn btn-secondary btn-lg w-100 mb-2" disabled>
                                        <i class="bi bi-check-circle me-2"></i>지원완료
                                    </button>
                                </div>
                                <div th:unless="${hasApplied}">
                                    <a th:href="@{/personal/apply/{id}(id=${job.id})}" class="btn btn-primary btn-lg w-100 mb-2">
                                        <i class="bi bi-send me-2"></i>지원하기
                                    </a>
                                </div>
                            </div>
                            <div th:if="${dDay < 0}">
                                <button class="btn btn-secondary btn-lg w-100 mb-2" disabled>
                                    <i class="bi bi-x-circle me-2"></i>마감된 공고
                                </button>
                            </div>

                            <!-- 관심공고 -->
                            <button th:if="${isFavorite}" class="btn btn-outline-danger w-100"
                                    onclick="toggleFavorite(false)">
                                <i class="bi bi-heart-fill me-2"></i>관심공고 해제
                            </button>
                            <button th:unless="${isFavorite}" class="btn btn-outline-primary w-100"
                                    onclick="toggleFavorite(true)">
                                <i class="bi bi-heart me-2"></i>관심공고 등록
                            </button>
                        </div>

                        <!-- 기업회원 -->
                        <div sec:authorize="hasRole('COMPANY')">
                            <p class="text-muted text-center mb-0">
                                <i class="bi bi-info-circle me-1"></i>기업회원은 지원이 불가합니다.
                            </p>
                        </div>

                        <!-- 관리자 -->
                        <div sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/admin/jobs}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-gear me-2"></i>관리자 페이지
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>

<script th:inline="javascript">
    const jobId = [[${job.id}]];

    function toggleFavorite(add) {
        const url = add ? '/personal/favorite/add' : '/personal/favorite/remove';
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'jobId=' + jobId
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '처리 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('처리 중 오류가 발생했습니다.');
            });
    }
</script>
</body>
</html>